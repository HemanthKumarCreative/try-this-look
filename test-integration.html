<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NUSENSE TryON - Integration Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        padding: clamp(16px, 3vw, 24px);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .product-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: clamp(16px, 4vw, 40px);
        margin-top: 20px;
      }
      .product-images {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .main-image {
        width: 100%;
        height: min(60vw, 520px);
        object-fit: cover;
        border-radius: 8px;
      }
      .thumbnail-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      .thumbnail {
        width: 100%;
        height: min(22vw, 110px);
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .thumbnail:hover {
        transform: scale(1.05);
      }
      .product-info h1 {
        font-size: clamp(1.5rem, 4.5vw, 2.5rem);
        margin: 0 0 10px 0;
        color: #333;
      }
      .price {
        font-size: clamp(1.25rem, 4vw, 2rem);
        font-weight: bold;
        color: #e74c3c;
        margin: 20px 0;
      }
      .description {
        color: #666;
        line-height: 1.6;
        margin: 20px 0;
      }
      .tryon-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: clamp(12px, 2.5vw, 16px) clamp(18px, 4vw, 28px);
        font-size: clamp(1rem, 3.5vw, 1.1rem);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: clamp(12px, 3vw, 20px) 0;
        width: 100%;
      }
      .tryon-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .info-box {
        background: #e8f4fd;
        border: 1px solid #bee5eb;
        border-radius: 8px;
        padding: clamp(12px, 2.5vw, 16px);
        margin: clamp(12px, 3vw, 20px) 0;
      }
      .info-box h3 {
        margin: 0 0 10px 0;
        color: #0c5460;
      }
      @media (max-width: 900px) {
        .product-grid {
          grid-template-columns: 1fr;
        }
        .main-image {
          height: min(68vw, 520px);
        }
        .thumbnail {
          height: min(22vw, 100px);
        }
      }
      @media (max-width: 600px) {
        .thumbnail-grid {
          grid-template-columns: repeat(3, 1fr);
          gap: 8px;
        }
        .main-image {
          height: min(75vw, 480px);
        }
      }
      .info-box p {
        margin: 5px 0;
        color: #0c5460;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>NUSENSE TryON - Integration Test Page</h1>
      <p>
        This page simulates a Shopify product page to test the TryON widget's
        image extraction functionality.
      </p>

      <div class="product-grid">
        <!-- Product Images Section -->
        <div class="product-images">
          <img
            src="https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=800&h=600&fit=crop&crop=center"
            alt="Premium Cotton T-Shirt - Front View"
            class="main-image"
            data-product-image="true"
          />
          <div class="thumbnail-grid">
            <img
              src="https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=200&h=200&fit=crop&crop=center"
              alt="Premium Cotton T-Shirt - Front"
              class="thumbnail"
              data-product-image="true"
            />
            <img
              src="https://images.unsplash.com/photo-1503341504253-dff4815485f1?w=200&h=200&fit=crop&crop=center"
              alt="Premium Cotton T-Shirt - Back"
              class="thumbnail"
              data-product-image="true"
            />
            <img
              src="https://images.unsplash.com/photo-1551698618-1dfe5d97d256?w=200&h=200&fit=crop&crop=center"
              alt="Premium Cotton T-Shirt - Side"
              class="thumbnail"
              data-product-image="true"
            />
            <img
              src="https://images.unsplash.com/photo-1576566588028-43ea1fd157cf?w=200&h=200&fit=crop&crop=center"
              alt="Premium Cotton T-Shirt - Detail"
              class="thumbnail"
              data-product-image="true"
            />
          </div>
        </div>

        <!-- Product Info Section -->
        <div class="product-info">
          <h1>Premium Cotton T-Shirt</h1>
          <div class="price">$49.99</div>
          <div class="description">
            Premium organic cotton t-shirt with regular fit. Made sustainably
            with high-quality materials. Perfect for a casual and comfortable
            style. Available in multiple colors and sizes.
          </div>

          <button class="tryon-button" id="nusense-tryon-btn">
            âœ¨ Try Virtually with AI
          </button>

          <div class="info-box">
            <h3>ðŸ§ª Test Information</h3>
            <p>
              <strong>Purpose:</strong> This page tests the NUSENSE TryON
              widget's ability to extract product images from the parent
              website.
            </p>
            <p>
              <strong>Expected Behavior:</strong> When you click "Try
              Virtually", the widget should show the 4 product images from this
              page.
            </p>
            <p>
              <strong>Images Detected:</strong>
              <span id="image-count">Loading...</span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- NUSENSE TryON Integration Script -->
    <script>
      // Simulate Shopify product data
      window.Shopify = {
        product: {
          id: "test-product-123",
          title: "Premium Cotton T-Shirt",
          price: 4999, // in cents
          images: [
            "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=800&h=600&fit=crop&crop=center",
            "https://images.unsplash.com/photo-1503341504253-dff4815485f1?w=200&h=200&fit=crop&crop=center",
            "https://images.unsplash.com/photo-1551698618-1dfe5d97d256?w=200&h=200&fit=crop&crop=center",
            "https://images.unsplash.com/photo-1576566588028-43ea1fd157cf?w=200&h=200&fit=crop&crop=center",
          ],
        },
      };

      // Image extraction function (same as in the Shopify integration)
      function extractProductImages() {
        const images = [];
        const seenUrls = new Set();

        function addImage(url, metadata) {
          if (!url || seenUrls.has(url)) return;

          const cleanUrl = cleanImageUrl(url);
          if (!cleanUrl || seenUrls.has(cleanUrl)) return;

          if (isValidProductImageUrl(cleanUrl, metadata)) {
            images.push(cleanUrl);
            seenUrls.add(cleanUrl);
          }
        }

        function cleanImageUrl(url) {
          if (!url || typeof url !== "string") return null;

          try {
            const urlObj = new URL(url, window.location.href);
            const keepParams = ["quality", "format"];
            const params = new URLSearchParams();

            for (const [key, value] of urlObj.searchParams.entries()) {
              if (keepParams.includes(key.toLowerCase())) {
                params.set(key, value);
              }
            }

            urlObj.search = params.toString();
            return urlObj.href;
          } catch {
            return url;
          }
        }

        function isValidProductImageUrl(url, metadata) {
          if (!url) return false;

          const lowerUrl = url.toLowerCase();
          const lowerAlt = (metadata?.alt || "").toLowerCase();

          // For this test, be more lenient with validation
          console.log("Validating image:", url, "metadata:", metadata);

          const excludePatterns = [
            "logo",
            "icon",
            "badge",
            "payment",
            "trust",
            "review",
            "star",
            "avatar",
            "user",
            "profile",
            "social",
            "facebook",
            "twitter",
            "instagram",
            "pinterest",
            "google",
            "analytics",
            "tracking",
            "pixel",
            "spacer",
            "blank",
            "placeholder",
            "1x1",
            "pixel.gif",
            "transparent",
            ".svg",
          ];

          for (const pattern of excludePatterns) {
            if (lowerUrl.includes(pattern) || lowerAlt.includes(pattern)) {
              console.log("Excluded due to pattern:", pattern);
              return false;
            }
          }

          // Accept common image formats
          const validExtensions = [
            ".jpg",
            ".jpeg",
            ".png",
            ".webp",
            ".gif",
            ".avif",
          ];
          const hasValidExtension = validExtensions.some((ext) =>
            lowerUrl.includes(ext)
          );

          // For this test, be more lenient with size requirements
          if (metadata) {
            const { width, height } = metadata;
            // Only exclude very small images (likely icons)
            if (width && height && width < 50 && height < 50) {
              console.log("Excluded due to small size:", width, "x", height);
              return false;
            }
          }

          // Must be a valid URL
          try {
            new URL(url, window.location.href);
          } catch {
            console.log("Excluded due to invalid URL");
            return false;
          }

          console.log("Image accepted:", url);
          return true;
        }

        // Extract from all img elements
        const imgElements = document.querySelectorAll("img");
        console.log("Found img elements:", imgElements.length);

        imgElements.forEach((img, index) => {
          console.log(`Processing img ${index}:`, img.src, img.alt);

          const sources = [
            img.src,
            img.dataset.src,
            img.dataset.lazySrc,
            img.dataset.originalSrc,
            img.dataset.productImage,
            img.currentSrc,
            img.getAttribute("data-original"),
            img.getAttribute("data-lazy"),
          ].filter(Boolean);

          if (img.srcset) {
            const srcsetUrls = img.srcset
              .split(",")
              .map((entry) => {
                const parts = entry.trim().split(/\s+/);
                return parts[0];
              })
              .filter(Boolean);
            sources.push(...srcsetUrls);
          }

          sources.forEach((src) => {
            console.log(`Adding image source: ${src}`);
            addImage(src, {
              width: img.naturalWidth || img.width,
              height: img.naturalHeight || img.height,
              alt: img.alt,
            });
          });
        });

        // Also try to extract from specific product image selectors
        const productImageSelectors = [
          'img[data-product-image="true"]',
          ".main-image",
          ".thumbnail",
          'img[alt*="T-Shirt"]',
          'img[alt*="Premium"]',
        ];

        productImageSelectors.forEach((selector) => {
          const elements = document.querySelectorAll(selector);
          console.log(
            `Found ${elements.length} elements for selector: ${selector}`
          );
          elements.forEach((img, index) => {
            if (img instanceof HTMLImageElement) {
              console.log(`Product image ${index}:`, img.src, img.alt);
              addImage(img.src, {
                width: img.naturalWidth || img.width,
                height: img.naturalHeight || img.height,
                alt: img.alt,
              });
            }
          });
        });

        return images;
      }

      // Initialize the test
      document.addEventListener("DOMContentLoaded", function () {
        const images = extractProductImages();
        document.getElementById(
          "image-count"
        ).textContent = `${images.length} product images detected`;

        console.log("Detected product images:", images);
      });

      // Listen for image requests from iframe
      window.addEventListener("message", (event) => {
        if (event.data.type === "NUSENSE_REQUEST_IMAGES") {
          const images = extractProductImages();
          if (event.source && event.source !== window) {
            event.source.postMessage(
              {
                type: "NUSENSE_PRODUCT_IMAGES",
                images: images,
              },
              "*"
            );
          }
        }
      });
    </script>

    <!-- Include the NUSENSE TryON Widget -->
    <script
      src="https://try-this-look.vercel.app/nusense-tryon-widget.js"
      async
      defer
    ></script>
  </body>
</html>
