{% comment %}
  NUSENSE TryON Script Snippet
  Include this once per page to load the widget functionality
  
  Usage:
  {% render 'nusense-tryon-script' %}
  
  Or with custom parameters:
  {% render 'nusense-tryon-script', 
     widget_url: 'https://your-widget-url.com',
     debug_mode: true %}
{% endcomment %}

{% assign widget_url = widget_url | default: 'https://try-this-look.vercel.app' %}
{% assign debug_mode = debug_mode | default: false %}

<script>
  // Initialize widget configuration
  window.NUSENSE_CONFIG = {
    widgetUrl: '{{ widget_url }}',
    debug: {{ debug_mode }},
    autoDetect: true
  };
  
  // Product data for NUSENSE widget
  {% if product %}
  window.NUSENSE_PRODUCT_DATA = {
    title: "{{ product.title | escape }}",
    price: "{{ product.price | money }}",
    images: [
      {% for image in product.images limit: 10 %}
        "{{ image | img_url: '800x800' }}"{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
    description: "{{ product.description | strip_html | truncate: 200 | escape }}",
    variants: [
      {% for variant in product.variants %}
        {
          id: {{ variant.id }},
          title: "{{ variant.title | escape }}",
          price: "{{ variant.price | money }}",
          available: {{ variant.available }},
          {% if variant.option1 %}option1: "{{ variant.option1 | escape }}",{% endif %}
          {% if variant.option2 %}option2: "{{ variant.option2 | escape }}",{% endif %}
          {% if variant.option3 %}option3: "{{ variant.option3 | escape }}"{% endif %}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
    url: "{{ shop.url }}{{ product.url }}",
    shop: {
      name: "{{ shop.name | escape }}",
      domain: "{{ shop.permanent_domain }}"
    }
  };
  {% endif %}
  
  // Load widget script if not already loaded
  (function() {
    if (!document.querySelector('script[src*="nusense-tryon-widget.js"]')) {
      const script = document.createElement('script');
      script.src = '{{ widget_url }}/nusense-tryon-widget.js';
      script.async = true;
      script.defer = true;
      script.onload = function() {
        if (window.NUSENSE_CONFIG && window.NUSENSE_CONFIG.debug) {
          console.log('NUSENSE TryON Widget loaded successfully');
        }
      };
      script.onerror = function() {
        console.error('Failed to load NUSENSE TryON Widget from {{ widget_url }}');
      };
      document.head.appendChild(script);
    }
  })();
</script>

