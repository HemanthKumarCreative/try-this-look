{% comment %}
  NUSENSE TryON App Embed Block
  This app embed block will appear in "Theme Settings > App embeds"
  It initializes the widget functionality and image extraction listener
  Can inject a try-on button into the header automatically
{% endcomment %}

{% comment %} Include the snippet that sets up image extraction and communication {% endcomment %}
{% render 'nusense-tryon-script' %}

{% comment %}
  Header Button Injection Script
  This script injects a try-on button into the header on product pages
{% endcomment %}
{% if block.settings.show_header_button %}
<script>
  (function() {
    'use strict';
    
    // Only run on product pages
    {% unless product %}
    return;
    {% endunless %}
    
    // Configuration from block settings
    const config = {
      widgetUrl: {{ block.settings.widget_url | default: shop.metafields.nusense.widget_url | default: 'https://try-this-look.vercel.app' | json }},
      buttonText: {{ block.settings.button_text | default: 'Try On' | json }},
      buttonIcon: {{ block.settings.button_icon | default: '✨' | json }},
      buttonStyle: {{ block.settings.button_style | default: 'minimal' | json }},
      headerSelector: {{ block.settings.header_selector | default: 'header, .header, .site-header, [role="banner"]' | json }},
      insertPosition: {{ block.settings.insert_position | default: 'end' | json }},
      insertSelector: {{ block.settings.insert_selector | default: '' | json }},
      debug: {{ block.settings.enable_debug | default: false }}
    };
    
    function log(message, data) {
      if (config.debug) {
        console.log('NUSENSE [Header Button]:', message, data || '');
      }
    }
    
    function createButton() {
      // Create button element
      const button = document.createElement('button');
      button.type = 'button';
      button.id = 'nusense-header-tryon-btn';
      button.className = 'nusense-tryon-header-button';
      button.setAttribute('aria-label', config.buttonText);
      
      // Set button content
      button.innerHTML = `
        <span class="nusense-button-icon">${config.buttonIcon}</span>
        <span class="nusense-button-text">${config.buttonText}</span>
      `;
      
      // Apply button style classes
      const styleClasses = {
        'primary': 'nusense-btn-primary',
        'secondary': 'nusense-btn-secondary',
        'outline': 'nusense-btn-outline',
        'minimal': 'nusense-btn-minimal'
      };
      button.classList.add(styleClasses[config.buttonStyle] || styleClasses['minimal']);
      
      // Add click handler
      button.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const productId = {{ product.id | json }};
        const widgetUrl = config.widgetUrl + '/widget?product_id=' + productId;
        
        log('Opening widget modal', { productId, widgetUrl });
        
        // Create modal overlay
        const overlay = document.createElement('div');
        overlay.id = 'nusense-widget-overlay';
        overlay.className = 'nusense-widget-overlay';
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 99999;
          display: flex;
          align-items: center;
          justify-content: center;
          backdrop-filter: blur(4px);
        `;
        
        // Create container for iframe
        const container = document.createElement('div');
        container.className = 'nusense-widget-container';
        container.style.cssText = `
          position: relative;
          width: 95vw;
          max-width: 1200px;
          height: 90vh;
          background: white;
          border-radius: 0.5rem;
          overflow: hidden;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        `;
        
        // Close button
        const closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.className = 'nusense-widget-close';
        closeBtn.innerHTML = '×';
        closeBtn.style.cssText = `
          position: absolute;
          top: 1rem;
          right: 1rem;
          width: 2.5rem;
          height: 2.5rem;
          border-radius: 50%;
          border: none;
          background: rgba(255, 255, 255, 0.9);
          color: #333;
          font-size: 1.5rem;
          cursor: pointer;
          z-index: 100000;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s;
        `;
        closeBtn.addEventListener('mouseenter', function() {
          this.style.background = '#fff';
          this.style.transform = 'scale(1.1)';
        });
        closeBtn.addEventListener('mouseleave', function() {
          this.style.background = 'rgba(255, 255, 255, 0.9)';
          this.style.transform = 'scale(1)';
        });
        
        // Close function
        const closeWidget = function() {
          if (overlay && overlay.parentNode) {
            document.body.removeChild(overlay);
            document.body.style.overflow = '';
          }
        };
        
        closeBtn.addEventListener('click', closeWidget);
        overlay.addEventListener('click', function(e) {
          if (e.target === overlay) {
            closeWidget();
          }
        });
        
        // Create iframe
        const iframe = document.createElement('iframe');
        iframe.src = widgetUrl;
        iframe.style.cssText = `
          width: 100%;
          height: 100%;
          border: none;
          background: white;
        `;
        iframe.allow = 'camera; microphone';
        iframe.setAttribute('allowfullscreen', 'true');
        
        // Assemble modal
        container.appendChild(closeBtn);
        container.appendChild(iframe);
        overlay.appendChild(container);
        document.body.appendChild(overlay);
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
        
        // Close on escape key
        const closeHandler = function(e) {
          if (e.key === 'Escape') {
            closeWidget();
            document.removeEventListener('keydown', closeHandler);
          }
        };
        document.addEventListener('keydown', closeHandler);
        
        // Listen for close messages from iframe
        const messageHandler = function(e) {
          if (e.data && e.data.type === 'NUSENSE_CLOSE_WIDGET') {
            closeWidget();
            window.removeEventListener('message', messageHandler);
          }
        };
        window.addEventListener('message', messageHandler);
      });
      
      return button;
    }
    
    function injectButton() {
      // Check if button already exists
      if (document.getElementById('nusense-header-tryon-btn')) {
        log('Button already exists, skipping injection');
        return;
      }
      
      // Find header element
      let header = null;
      
      // Try custom selector first
      if (config.insertSelector) {
        header = document.querySelector(config.insertSelector);
        if (header) {
          log('Found header using custom selector', config.insertSelector);
        }
      }
      
      // Try common header selectors
      if (!header) {
        const selectors = config.headerSelector.split(',').map(s => s.trim());
        for (let i = 0; i < selectors.length; i++) {
          header = document.querySelector(selectors[i]);
          if (header) {
            log('Found header using selector', selectors[i]);
            break;
          }
        }
      }
      
      if (!header) {
        log('Header not found, cannot inject button');
        return;
      }
      
      // Create button
      const button = createButton();
      
      // Determine insertion point
      let insertTarget = header;
      
      // If insert position is 'start', insert at beginning
      if (config.insertPosition === 'start') {
        header.insertBefore(button, header.firstChild);
        log('Button inserted at start of header');
      } else if (config.insertPosition === 'after') {
        // Insert after header
        if (header.nextSibling) {
          header.parentNode.insertBefore(button, header.nextSibling);
        } else {
          header.parentNode.appendChild(button);
        }
        log('Button inserted after header');
      } else {
        // Default: insert at end
        header.appendChild(button);
        log('Button inserted at end of header');
      }
    }
    
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(injectButton, 100);
      });
    } else {
      setTimeout(injectButton, 100);
    }
    
    // Also try after a delay in case header loads dynamically
    setTimeout(injectButton, 500);
    setTimeout(injectButton, 1000);
  })();
</script>

<style>
  .nusense-tryon-header-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    text-decoration: none;
  }
  
  .nusense-tryon-header-button:hover {
    transform: translateY(-1px);
  }
  
  .nusense-tryon-header-button:active {
    transform: translateY(0);
  }
  
  .nusense-button-icon {
    font-size: 1rem;
    line-height: 1;
  }
  
  .nusense-button-text {
    line-height: 1;
  }
  
  /* Button Style Variants */
  .nusense-btn-primary {
    background: #000;
    color: #fff;
  }
  
  .nusense-btn-primary:hover {
    background: #333;
  }
  
  .nusense-btn-secondary {
    background: #f5f5f5;
    color: #333;
  }
  
  .nusense-btn-secondary:hover {
    background: #e5e5e5;
  }
  
  .nusense-btn-outline {
    background: transparent;
    color: #333;
    border: 1px solid #333;
  }
  
  .nusense-btn-outline:hover {
    background: #333;
    color: #fff;
  }
  
  .nusense-btn-minimal {
    background: transparent;
    color: #333;
  }
  
  .nusense-btn-minimal:hover {
    background: rgba(0, 0, 0, 0.05);
  }
</style>
{% endif %}

{% schema %}
{
  "name": "NUSENSE Try-On Widget",
  "target": "body",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": [
    {
      "type": "text",
      "id": "widget_url",
      "label": "Widget URL",
      "default": "https://try-this-look.vercel.app",
      "info": "The URL where your widget is hosted"
    },
    {
      "type": "checkbox",
      "id": "enable_debug",
      "label": "Enable Debug Mode",
      "default": false,
      "info": "Enable console logging for troubleshooting"
    },
    {
      "type": "header",
      "content": "Header Button Settings"
    },
    {
      "type": "checkbox",
      "id": "show_header_button",
      "label": "Show Try-On Button in Header",
      "default": true,
      "info": "Automatically inject a try-on button into the header on product pages"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Try On",
      "info": "Text to display on the button"
    },
    {
      "type": "text",
      "id": "button_icon",
      "label": "Button Icon (emoji)",
      "default": "✨",
      "info": "Emoji or icon to display before button text"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button Style",
      "options": [
        {
          "value": "primary",
          "label": "Primary (Black background)"
        },
        {
          "value": "secondary",
          "label": "Secondary (Gray background)"
        },
        {
          "value": "outline",
          "label": "Outline (Border only)"
        },
        {
          "value": "minimal",
          "label": "Minimal (Transparent)"
        }
      ],
      "default": "minimal",
      "info": "Visual style of the button"
    },
    {
      "type": "text",
      "id": "header_selector",
      "label": "Header Selector (CSS)",
      "default": "header, .header, .site-header, [role=\"banner\"]",
      "info": "CSS selector to find the header element. Multiple selectors separated by commas."
    },
    {
      "type": "select",
      "id": "insert_position",
      "label": "Button Position in Header",
      "options": [
        {
          "value": "start",
          "label": "Start of header"
        },
        {
          "value": "end",
          "label": "End of header (default)"
        },
        {
          "value": "after",
          "label": "After header"
        }
      ],
      "default": "end",
      "info": "Where to place the button relative to the header"
    },
    {
      "type": "text",
      "id": "insert_selector",
      "label": "Custom Insert Selector (optional)",
      "default": "",
      "info": "Optional: Specific CSS selector where button should be inserted. Leave empty to use header selector."
    }
  ]
}
{% endschema %}

