{% comment %}
  NUSENSE TryON App Embed Block
  This app embed block will appear in "Theme Settings > App embeds"
  It initializes the widget functionality and image extraction listener
  Can inject a try-on button into the header next to the cart icon
{% endcomment %}

{% comment %} Include the snippet that sets up image extraction and communication {% endcomment %}
{% render 'nusense-tryon-script' %}

{% comment %}
  Header Button Injection Script
  This script injects a try-on button into the header next to the cart icon
  Works on all pages, not just product pages
{% endcomment %}
{% if block.settings.show_header_button %}
<script>
  (function() {
    'use strict';
    
    // Configuration from block settings
    const config = {
      widgetUrl: {{ block.settings.widget_url | default: shop.metafields.nusense.widget_url | default: 'https://try-this-look.vercel.app' | json }},
      buttonText: {{ block.settings.button_text | default: 'Try On' | json }},
      buttonIcon: {{ block.settings.button_icon | default: '✨' | json }},
      buttonStyle: {{ block.settings.button_style | default: 'minimal' | json }},
      positionStrategy: {{ block.settings.position_strategy | default: 'logo' | json }},
      positionRelative: {{ block.settings.position_relative | default: 'after' | json }},
      logoSelector: {{ block.settings.logo_selector | json }},
      cartIconSelector: {{ block.settings.cart_icon_selector | default: 'a[href*="/cart"], .cart-icon, .cart-link, [data-cart-icon], .header__icon--cart, .site-header__cart, #cart-icon, .icon-cart, button[aria-label*="cart" i], a[aria-label*="cart" i], .header__cart, .cart, [data-cart]' | json }},
      customSelector: {{ block.settings.custom_selector | json }},
      debug: {{ block.settings.enable_debug | default: false }}
    };
    
    // Product data (available on product pages)
    const productId = {% if product %}{{ product.id | json }}{% else %}null{% endif %};
    const isProductPage = productId !== null;
    
    function log(message, data) {
      if (config.debug) {
        console.log('NUSENSE [Header Button]:', message, data || '');
      }
    }
    
    function createButton() {
      // Create button element
      const button = document.createElement('button');
      button.type = 'button';
      button.id = 'nusense-header-tryon-btn';
      button.className = 'nusense-tryon-header-button';
      button.setAttribute('aria-label', config.buttonText);
      
      // Set button content - icon only for header (compact)
      button.innerHTML = `
        <span class="nusense-button-icon">${config.buttonIcon}</span>
      `;
      
      // Apply button style classes
      const styleClasses = {
        'primary': 'nusense-btn-primary',
        'secondary': 'nusense-btn-secondary',
        'outline': 'nusense-btn-outline',
        'minimal': 'nusense-btn-minimal'
      };
      button.classList.add(styleClasses[config.buttonStyle] || styleClasses['minimal']);
      
      // Add click handler
      button.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Handle click based on page type
        if (isProductPage && productId) {
          // Product page: open widget with product
          const widgetUrl = config.widgetUrl + '/widget?product_id=' + productId;
          log('Opening widget modal on product page', { productId, widgetUrl });
          openWidgetModal(widgetUrl);
        } else {
          // Non-product page: show message or redirect to first product
          log('Button clicked on non-product page');
          handleNonProductPageClick();
        }
      });
      
      return button;
    }
    
    function openWidgetModal(widgetUrl) {
      // Create modal overlay
      const overlay = document.createElement('div');
      overlay.id = 'nusense-widget-overlay';
      overlay.className = 'nusense-widget-overlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 99999;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      `;
      
      // Create container for iframe
      const container = document.createElement('div');
      container.className = 'nusense-widget-container';
      container.style.cssText = `
        position: relative;
        width: 95vw;
        max-width: 1200px;
        height: 90vh;
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      `;
      
      // Close button
      const closeBtn = document.createElement('button');
      closeBtn.type = 'button';
      closeBtn.className = 'nusense-widget-close';
      closeBtn.innerHTML = '×';
      closeBtn.style.cssText = `
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 100000;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      `;
      closeBtn.addEventListener('mouseenter', function() {
        this.style.background = '#fff';
        this.style.transform = 'scale(1.1)';
      });
      closeBtn.addEventListener('mouseleave', function() {
        this.style.background = 'rgba(255, 255, 255, 0.9)';
        this.style.transform = 'scale(1)';
      });
      
      // Close function
      const closeWidget = function() {
        if (overlay && overlay.parentNode) {
          document.body.removeChild(overlay);
          document.body.style.overflow = '';
        }
      };
      
      closeBtn.addEventListener('click', closeWidget);
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          closeWidget();
        }
      });
      
      // Create iframe
      const iframe = document.createElement('iframe');
      iframe.src = widgetUrl;
      iframe.style.cssText = `
        width: 100%;
        height: 100%;
        border: none;
        background: white;
      `;
      iframe.allow = 'camera; microphone';
      iframe.setAttribute('allowfullscreen', 'true');
      
      // Assemble modal
      container.appendChild(closeBtn);
      container.appendChild(iframe);
      overlay.appendChild(container);
      document.body.appendChild(overlay);
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
      
      // Close on escape key
      const closeHandler = function(e) {
        if (e.key === 'Escape') {
          closeWidget();
          document.removeEventListener('keydown', closeHandler);
        }
      };
      document.addEventListener('keydown', closeHandler);
      
      // Listen for close messages from iframe
      const messageHandler = function(e) {
        if (e.data && e.data.type === 'NUSENSE_CLOSE_WIDGET') {
          closeWidget();
          window.removeEventListener('message', messageHandler);
        }
      };
      window.addEventListener('message', messageHandler);
    }
    
    function handleNonProductPageClick() {
      // On non-product pages, show a message or redirect to products
      // Option 1: Show alert (simple)
      alert('Please visit a product page to use the Try-On feature.');
      
      // Option 2: Redirect to collections/products page (uncomment if preferred)
      // const collectionsUrl = '/collections/all';
      // if (window.Shopify && window.Shopify.routes && window.Shopify.routes.root) {
      //   window.location.href = window.Shopify.routes.root + collectionsUrl;
      // } else {
      //   window.location.href = collectionsUrl;
      // }
    }
    
    function findLogo() {
      // Try custom selector first if provided
      if (config.logoSelector && typeof config.logoSelector === 'string' && config.logoSelector.trim() !== '') {
        const logo = document.querySelector(config.logoSelector);
        if (logo) {
          log('Found logo using custom selector', config.logoSelector);
          return logo;
        }
      }
      
      // Try to find logo using common selectors
      const logoSelectors = [
        '.logo',
        '.site-logo',
        '.header__logo',
        '.site-header__logo',
        '.header-logo',
        'a[href="/"]',
        'a[href*="/"] img',
        '.logo img',
        '[data-logo]',
        'h1 a',
        '.brand',
        '.site-brand'
      ];
      
      for (let i = 0; i < logoSelectors.length; i++) {
        const logo = document.querySelector(logoSelectors[i]);
        if (logo) {
          log('Found logo using selector', logoSelectors[i]);
          return logo;
        }
      }
      
      log('Logo not found using selectors');
      return null;
    }
    
    function findCartIcon() {
      // Try to find cart icon using common selectors
      const selectors = config.cartIconSelector.split(',').map(s => s.trim());
      
      for (let i = 0; i < selectors.length; i++) {
        const cartIcon = document.querySelector(selectors[i]);
        if (cartIcon) {
          log('Found cart icon using selector', selectors[i]);
          return cartIcon;
        }
      }
      
      log('Cart icon not found using selectors');
      return null;
    }
    
    function findCustomElement() {
      if (!config.customSelector || typeof config.customSelector !== 'string' || config.customSelector.trim() === '') {
        return null;
      }
      
      const element = document.querySelector(config.customSelector);
      if (element) {
        log('Found custom element using selector', config.customSelector);
        return element;
      }
      
      log('Custom element not found using selector', config.customSelector);
      return null;
    }
    
    function findTargetElement() {
      // Find target element based on position strategy
      switch (config.positionStrategy) {
        case 'logo':
          return findLogo();
        case 'cart':
          return findCartIcon();
        case 'custom':
          return findCustomElement();
        default:
          return findLogo(); // Default to logo
      }
    }
    
    function injectButton() {
      // Check if button already exists
      if (document.getElementById('nusense-header-tryon-btn')) {
        log('Button already exists, skipping injection');
        return;
      }
      
      // Find target element based on position strategy
      const targetElement = findTargetElement();
      
      if (!targetElement) {
        log('Target element not found, cannot inject button');
        return;
      }
      
      // Create button
      const button = createButton();
      
      // Find the header container
      let header = targetElement.closest('header');
      if (!header) {
        // Try common header selectors
        const headerSelectors = [
          'header',
          '.header',
          '.site-header',
          '[role="banner"]'
        ];
        for (let i = 0; i < headerSelectors.length; i++) {
          const found = document.querySelector(headerSelectors[i]);
          if (found && found.contains(targetElement)) {
            header = found;
            log('Found header using selector', headerSelectors[i]);
            break;
          }
        }
      }
      
      if (!header) {
        log('Header not found, using target element parent');
        header = targetElement.parentElement;
      }
      
      if (!header) {
        log('Could not find suitable container');
        return;
      }
      
      // Find the container that holds the target element (usually a div or nav)
      let targetContainer = targetElement.parentElement;
      
      // If target is in a link, get the link's parent
      if (targetElement.tagName === 'IMG' && targetElement.parentElement && targetElement.parentElement.tagName === 'A') {
        targetContainer = targetElement.parentElement.parentElement;
        log('Target element is in a link, using link parent as container');
      }
      
      // If target container is the header itself, insert directly in header
      if (targetContainer === header || !targetContainer) {
        // Insert button relative to target element in header
        if (config.positionRelative === 'before') {
          header.insertBefore(button, targetElement);
          log('Button inserted before target element in header');
        } else {
          if (targetElement.nextSibling) {
            header.insertBefore(button, targetElement.nextSibling);
            log('Button inserted after target element in header');
          } else {
            header.appendChild(button);
            log('Button appended to header after target element');
          }
        }
      } else {
        // Insert button relative to target element in its container
        if (config.positionRelative === 'before') {
          targetContainer.insertBefore(button, targetElement);
          log('Button inserted before target element in container');
        } else {
          if (targetElement.nextSibling) {
            targetContainer.insertBefore(button, targetElement.nextSibling);
            log('Button inserted after target element in container');
          } else {
            targetContainer.appendChild(button);
            log('Button appended to container after target element');
          }
        }
      }
    }
    
    // Wait for DOM to be ready
    function tryInject() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(injectButton, 100);
        });
      } else {
        injectButton();
      }
    }
    
    // Try multiple times to handle dynamic loading
    tryInject();
    setTimeout(tryInject, 500);
    setTimeout(tryInject, 1000);
    setTimeout(tryInject, 2000);
  })();
</script>

<style>
  .nusense-tryon-header-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    padding: 0.5rem;
    border: none;
    border-radius: 0.25rem;
    font-size: 1.25rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    text-decoration: none;
    min-width: 44px;
    min-height: 44px;
    line-height: 1;
  }
  
  .nusense-tryon-header-button:hover {
    transform: translateY(-1px);
  }
  
  .nusense-tryon-header-button:active {
    transform: translateY(0);
  }
  
  .nusense-button-icon {
    font-size: 1.25rem;
    line-height: 1;
    display: inline-block;
  }
  
  .nusense-button-text {
    line-height: 1;
  }
  
  /* Button Style Variants */
  .nusense-btn-primary {
    background: #000;
    color: #fff;
  }
  
  .nusense-btn-primary:hover {
    background: #333;
  }
  
  .nusense-btn-secondary {
    background: #f5f5f5;
    color: #333;
  }
  
  .nusense-btn-secondary:hover {
    background: #e5e5e5;
  }
  
  .nusense-btn-outline {
    background: transparent;
    color: #333;
    border: 1px solid #333;
  }
  
  .nusense-btn-outline:hover {
    background: #333;
    color: #fff;
  }
  
  .nusense-btn-minimal {
    background: transparent;
    color: #333;
  }
  
  .nusense-btn-minimal:hover {
    background: rgba(0, 0, 0, 0.05);
  }
</style>
{% endif %}

{% schema %}
{
  "name": "NUSENSE Try-On Widget",
  "target": "body",
  "settings": [
    {
      "type": "text",
      "id": "widget_url",
      "label": "Widget URL",
      "default": "https://try-this-look.vercel.app",
      "info": "The URL where your widget is hosted"
    },
    {
      "type": "checkbox",
      "id": "enable_debug",
      "label": "Enable Debug Mode",
      "default": false,
      "info": "Enable console logging for troubleshooting"
    },
    {
      "type": "header",
      "content": "Header Button Settings"
    },
    {
      "type": "checkbox",
      "id": "show_header_button",
      "label": "Show Try-On Button in Header",
      "default": true,
      "info": "Automatically inject a try-on button next to the cart icon in the header on all pages"
    },
    {
      "type": "text",
      "id": "button_icon",
      "label": "Button Icon (emoji)",
      "default": "✨",
      "info": "Emoji or icon to display on the button (icon only for compact header display)"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button Style",
      "options": [
        {
          "value": "primary",
          "label": "Primary (Black background)"
        },
        {
          "value": "secondary",
          "label": "Secondary (Gray background)"
        },
        {
          "value": "outline",
          "label": "Outline (Border only)"
        },
        {
          "value": "minimal",
          "label": "Minimal (Transparent)"
        }
      ],
      "default": "minimal",
      "info": "Visual style of the button"
    },
    {
      "type": "header",
      "content": "Positioning Settings"
    },
    {
      "type": "select",
      "id": "position_strategy",
      "label": "Position Relative To",
      "options": [
        {
          "value": "logo",
          "label": "Logo (default)"
        },
        {
          "value": "cart",
          "label": "Cart Icon"
        },
        {
          "value": "custom",
          "label": "Custom Element"
        }
      ],
      "default": "logo",
      "info": "Choose which element to position the button relative to"
    },
    {
      "type": "select",
      "id": "position_relative",
      "label": "Button Position",
      "options": [
        {
          "value": "before",
          "label": "Before (to the left)"
        },
        {
          "value": "after",
          "label": "After (to the right)"
        }
      ],
      "default": "after",
      "info": "Position the button before or after the target element"
    },
    {
      "type": "text",
      "id": "logo_selector",
      "label": "Logo Selector (CSS) - Optional",
      "info": "Optional: Custom CSS selector to find the logo. If not specified, common selectors will be used."
    },
    {
      "type": "text",
      "id": "cart_icon_selector",
      "label": "Cart Icon Selector (CSS) - Optional",
      "default": "a[href*=\"/cart\"], .cart-icon, .cart-link, [data-cart-icon], .header__icon--cart, .site-header__cart, #cart-icon, .icon-cart, button[aria-label*=\"cart\" i], a[aria-label*=\"cart\" i], .header__cart, .cart, [data-cart]",
      "info": "Optional: Custom CSS selector to find the cart icon. If not specified, common selectors will be used."
    },
    {
      "type": "text",
      "id": "custom_selector",
      "label": "Custom Element Selector (CSS)",
      "info": "Required if 'Custom Element' is selected. CSS selector to find the target element."
    }
  ]
}
{% endschema %}
