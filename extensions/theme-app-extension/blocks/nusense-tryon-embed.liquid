{% comment %}
  Bloc d'intégration d'application NUSENSE TryON
  Ce bloc d'intégration apparaîtra dans "Paramètres du thème > Intégrations d'applications"
  Il initialise la fonctionnalité du widget et l'écouteur d'extraction d'images
  Peut injecter un bouton d'essayage dans l'en-tête à côté de l'icône du panier
{% endcomment %}

{% comment %} Inclure le snippet qui configure l'extraction d'images et la communication {% endcomment %}
{% render 'nusense-tryon-script' %}

{% comment %}
  Script d'injection du bouton dans l'en-tête
  Ce script injecte un bouton d'essayage dans l'en-tête à côté de l'icône du panier
  Fonctionne sur toutes les pages, pas seulement les pages produit
{% endcomment %}
{% if block.settings.show_header_button %}
<script>
  (function() {
    'use strict';
    
    // Configuration à partir des paramètres du bloc
    const config = {
      widgetUrl: {{ block.settings.widget_url | default: shop.metafields.nusense.widget_url | default: 'https://try-this-look.vercel.app' | json }},
      buttonText: {{ block.settings.button_text | default: 'Essayer' | json }},
      buttonIcon: {{ block.settings.button_icon | default: '✨' | json }},
      buttonStyle: {{ block.settings.button_style | default: 'minimal' | json }},
      positionLeft: {{ block.settings.position_left | default: '' | json }},
      positionRight: {{ block.settings.position_right | default: '' | json }},
      positionTop: {{ block.settings.position_top | default: '' | json }},
      positionBottom: {{ block.settings.position_bottom | default: '' | json }},
      debug: {{ block.settings.enable_debug | default: false }}
    };
    
    // Données produit (disponibles sur les pages produit)
    const productId = {% if product %}{{ product.id | json }}{% else %}null{% endif %};
    const isProductPage = productId !== null;
    
    function log(message, data) {
      if (config.debug) {
        console.log('NUSENSE [Bouton En-tête]:', message, data || '');
      }
    }
    
    function createButton() {
      // Créer l'élément bouton
      const button = document.createElement('button');
      button.type = 'button';
      button.id = 'nusense-header-tryon-btn';
      button.className = 'nusense-tryon-header-button';
      button.setAttribute('aria-label', config.buttonText);
      
      // Définir le contenu du bouton - icône uniquement pour l'en-tête (compact)
      button.innerHTML = `
        <span class="nusense-button-icon">${config.buttonIcon}</span>
      `;
      
      // Appliquer les classes de style du bouton
      const styleClasses = {
        'primary': 'nusense-btn-primary',
        'secondary': 'nusense-btn-secondary',
        'outline': 'nusense-btn-outline',
        'minimal': 'nusense-btn-minimal'
      };
      button.classList.add(styleClasses[config.buttonStyle] || styleClasses['minimal']);
      
      // Appliquer le positionnement absolu
      button.style.position = 'absolute';
      button.style.zIndex = '9999';
      
      // Appliquer les valeurs de positionnement en pixels
      if (config.positionLeft && config.positionLeft.trim() !== '') {
        const leftValue = config.positionLeft.trim();
        button.style.left = leftValue.includes('px') ? leftValue : leftValue + 'px';
      }
      
      if (config.positionRight && config.positionRight.trim() !== '') {
        const rightValue = config.positionRight.trim();
        button.style.right = rightValue.includes('px') ? rightValue : rightValue + 'px';
      }
      
      if (config.positionTop && config.positionTop.trim() !== '') {
        const topValue = config.positionTop.trim();
        button.style.top = topValue.includes('px') ? topValue : topValue + 'px';
      }
      
      if (config.positionBottom && config.positionBottom.trim() !== '') {
        const bottomValue = config.positionBottom.trim();
        button.style.bottom = bottomValue.includes('px') ? bottomValue : bottomValue + 'px';
      }
      
      log('Positionnement absolu appliqué', {
        left: config.positionLeft,
        right: config.positionRight,
        top: config.positionTop,
        bottom: config.positionBottom
      });
      
      // Ajouter le gestionnaire de clic
      button.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Gérer le clic selon le type de page
        if (isProductPage && productId) {
          // Page produit : ouvrir le widget avec le produit
          const widgetUrl = config.widgetUrl + '/widget?product_id=' + productId;
          log('Ouverture de la modale du widget sur la page produit', { productId, widgetUrl });
          openWidgetModal(widgetUrl);
        } else {
          // Page non-produit : afficher un message ou rediriger vers le premier produit
          log('Bouton cliqué sur une page non-produit');
          handleNonProductPageClick();
        }
      });
      
      return button;
    }
    
    function openWidgetModal(widgetUrl) {
      // Créer l'overlay de la modale
      const overlay = document.createElement('div');
      overlay.id = 'nusense-widget-overlay';
      overlay.className = 'nusense-widget-overlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 99999;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      `;
      
      // Créer le conteneur pour l'iframe
      const container = document.createElement('div');
      container.className = 'nusense-widget-container';
      container.style.cssText = `
        position: relative;
        width: 95vw;
        max-width: 1200px;
        height: 90vh;
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      `;
      
      // Bouton de fermeture
      const closeBtn = document.createElement('button');
      closeBtn.type = 'button';
      closeBtn.className = 'nusense-widget-close';
      closeBtn.innerHTML = '×';
      closeBtn.style.cssText = `
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 100000;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      `;
      closeBtn.addEventListener('mouseenter', function() {
        this.style.background = '#fff';
        this.style.transform = 'scale(1.1)';
      });
      closeBtn.addEventListener('mouseleave', function() {
        this.style.background = 'rgba(255, 255, 255, 0.9)';
        this.style.transform = 'scale(1)';
      });
      
      // Fonction de fermeture
      const closeWidget = function() {
        if (overlay && overlay.parentNode) {
          document.body.removeChild(overlay);
          document.body.style.overflow = '';
        }
      };
      
      closeBtn.addEventListener('click', closeWidget);
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          closeWidget();
        }
      });
      
      // Créer l'iframe
      const iframe = document.createElement('iframe');
      iframe.src = widgetUrl;
      iframe.style.cssText = `
        width: 100%;
        height: 100%;
        border: none;
        background: white;
      `;
      iframe.allow = 'camera; microphone';
      iframe.setAttribute('allowfullscreen', 'true');
      
      // Assembler la modale
      container.appendChild(closeBtn);
      container.appendChild(iframe);
      overlay.appendChild(container);
      document.body.appendChild(overlay);
      
      // Empêcher le défilement du corps
      document.body.style.overflow = 'hidden';
      
      // Fermer avec la touche Échap
      const closeHandler = function(e) {
        if (e.key === 'Escape') {
          closeWidget();
          document.removeEventListener('keydown', closeHandler);
        }
      };
      document.addEventListener('keydown', closeHandler);
      
      // Écouter les messages de fermeture de l'iframe
      const messageHandler = function(e) {
        if (e.data && e.data.type === 'NUSENSE_CLOSE_WIDGET') {
          closeWidget();
          window.removeEventListener('message', messageHandler);
        }
      };
      window.addEventListener('message', messageHandler);
    }
    
    function handleNonProductPageClick() {
      // Sur les pages non-produit, afficher un message ou rediriger vers les produits
      // Option 1 : Afficher une alerte (simple)
      alert('Veuillez visiter une page produit pour utiliser la fonctionnalité d\'essayage virtuel.');
      
      // Option 2 : Rediriger vers la page collections/produits (décommenter si préféré)
      // const collectionsUrl = '/collections/all';
      // if (window.Shopify && window.Shopify.routes && window.Shopify.routes.root) {
      //   window.location.href = window.Shopify.routes.root + collectionsUrl;
      // } else {
      //   window.location.href = collectionsUrl;
      // }
    }
    
    function injectButton() {
      // Vérifier si le bouton existe déjà
      if (document.getElementById('nusense-header-tryon-btn')) {
        log('Le bouton existe déjà, injection ignorée');
        return;
      }
      
      // Créer le bouton
      const button = createButton();
      
      // Trouver le conteneur de l'en-tête
      let header = document.querySelector('header');
      if (!header) {
        // Essayer des sélecteurs d'en-tête communs
        const headerSelectors = [
          '.header',
          '.site-header',
          '[role="banner"]'
        ];
        for (let i = 0; i < headerSelectors.length; i++) {
          const found = document.querySelector(headerSelectors[i]);
          if (found) {
            header = found;
            log('En-tête trouvé avec le sélecteur', headerSelectors[i]);
            break;
          }
        }
      }
      
      if (!header) {
        log('En-tête non trouvé, utilisation du body');
        header = document.body;
      }
      
      // S'assurer que le header a position: relative pour le positionnement absolu
      if (header) {
        const headerStyle = window.getComputedStyle(header);
        if (headerStyle.position === 'static') {
          header.style.position = 'relative';
          log('Position relative appliquée à l\'en-tête pour le positionnement absolu');
        }
      }
      
      // Ajouter le bouton à l'en-tête
      header.appendChild(button);
      log('Bouton ajouté à l\'en-tête avec positionnement absolu');
    }
    
    // Attendre que le DOM soit prêt
    function tryInject() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(injectButton, 100);
        });
      } else {
        injectButton();
      }
    }
    
    // Essayer plusieurs fois pour gérer le chargement dynamique
    tryInject();
    setTimeout(tryInject, 500);
    setTimeout(tryInject, 1000);
    setTimeout(tryInject, 2000);
  })();
</script>

<style>
  .nusense-tryon-header-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    padding: 0.5rem;
    border: none;
    border-radius: 0.25rem;
    font-size: 1.25rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    text-decoration: none;
    min-width: 44px;
    min-height: 44px;
    line-height: 1;
  }
  
  .nusense-tryon-header-button:hover {
    transform: translateY(-1px);
  }
  
  .nusense-tryon-header-button:active {
    transform: translateY(0);
  }
  
  .nusense-button-icon {
    font-size: 1.25rem;
    line-height: 1;
    display: inline-block;
  }
  
  .nusense-button-text {
    line-height: 1;
  }
  
  /* Button Style Variants */
  .nusense-btn-primary {
    background: #000;
    color: #fff;
  }
  
  .nusense-btn-primary:hover {
    background: #333;
  }
  
  .nusense-btn-secondary {
    background: #f5f5f5;
    color: #333;
  }
  
  .nusense-btn-secondary:hover {
    background: #e5e5e5;
  }
  
  .nusense-btn-outline {
    background: transparent;
    color: #333;
    border: 1px solid #333;
  }
  
  .nusense-btn-outline:hover {
    background: #333;
    color: #fff;
  }
  
  .nusense-btn-minimal {
    background: transparent;
    color: #333;
  }
  
  .nusense-btn-minimal:hover {
    background: rgba(0, 0, 0, 0.05);
  }
</style>
{% endif %}

{% schema %}
{
  "name": "Widget NUSENSE Try-On",
  "target": "body",
  "settings": [
    {
      "type": "text",
      "id": "widget_url",
      "label": "URL du Widget",
      "default": "https://try-this-look.vercel.app",
      "info": "L'URL où votre widget est hébergé"
    },
    {
      "type": "checkbox",
      "id": "enable_debug",
      "label": "Activer le Mode Débogage",
      "default": false,
      "info": "Activer la journalisation de la console pour le dépannage"
    },
    {
      "type": "header",
      "content": "Paramètres du Bouton d'En-tête"
    },
    {
      "type": "checkbox",
      "id": "show_header_button",
      "label": "Afficher le Bouton d'Essayage dans l'En-tête",
      "default": true,
      "info": "Injecter automatiquement un bouton d'essayage à côté de l'icône du panier dans l'en-tête sur toutes les pages"
    },
    {
      "type": "text",
      "id": "button_icon",
      "label": "Icône du Bouton (emoji)",
      "default": "✨",
      "info": "Emoji ou icône à afficher sur le bouton (icône uniquement pour un affichage compact dans l'en-tête)"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Style du Bouton",
      "options": [
        {
          "value": "primary",
          "label": "Principal (Fond noir)"
        },
        {
          "value": "secondary",
          "label": "Secondaire (Fond gris)"
        },
        {
          "value": "outline",
          "label": "Contour (Bordure uniquement)"
        },
        {
          "value": "minimal",
          "label": "Minimal (Transparent)"
        }
      ],
      "default": "minimal",
      "info": "Style visuel du bouton"
    },
    {
      "type": "header",
      "content": "Paramètres de Positionnement"
    },
    {
      "type": "text",
      "id": "position_left",
      "label": "Position Gauche (px)",
      "info": "Distance depuis la gauche en pixels (ex: 20px ou 20). Laissez vide pour ne pas définir."
    },
    {
      "type": "text",
      "id": "position_right",
      "label": "Position Droite (px)",
      "info": "Distance depuis la droite en pixels (ex: 20px ou 20). Laissez vide pour ne pas définir."
    },
    {
      "type": "text",
      "id": "position_top",
      "label": "Position Haut (px)",
      "info": "Distance depuis le haut en pixels (ex: 20px ou 20). Laissez vide pour ne pas définir."
    },
    {
      "type": "text",
      "id": "position_bottom",
      "label": "Position Bas (px)",
      "info": "Distance depuis le bas en pixels (ex: 20px ou 20). Laissez vide pour ne pas définir."
    }
  ]
}
{% endschema %}
