{% comment %}
  NUSENSE TryON Script
  Loads the widget functionality
{% endcomment %}

{% assign widget_url = shop.metafields.nusense.widget_url | default: 'https://try-this-look.vercel.app' %}
{% assign debug_mode = shop.metafields.nusense.debug_mode | default: false %}

<script>
  // Initialize widget configuration
  window.NUSENSE_CONFIG = {
    widgetUrl: '{{ widget_url }}',
    debug: {{ debug_mode }},
    autoDetect: true,
    shopDomain: '{{ shop.permanent_domain }}'
  };
  
  // Product data for NUSENSE widget
  {% if product %}
  window.NUSENSE_PRODUCT_DATA = {
    id: {{ product.id }},
    title: {{ product.title | json }},
    price: "{{ product.price | money }}",
    priceRaw: {{ product.price | money_without_currency }},
    images: [
      {% for image in product.images limit: 10 %}
        "{{ image | image_url: width: 800 }}"{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
    description: {{ product.description | strip_html | truncate: 200 | json }},
    variants: [
      {% for variant in product.variants %}
        {
          id: {{ variant.id }},
          title: {{ variant.title | json }},
          price: "{{ variant.price | money }}",
          priceRaw: {{ variant.price | money_without_currency }},
          available: {{ variant.available | json }},
          {% if variant.option1 %}option1: {{ variant.option1 | json }},{% endif %}
          {% if variant.option2 %}option2: {{ variant.option2 | json }},{% endif %}
          {% if variant.option3 %}option3: {{ variant.option3 | json }}{% endif %}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
    url: "{{ shop.url }}{{ product.url }}",
    shop: {
      name: {{ shop.name | json }},
      domain: "{{ shop.permanent_domain }}"
    }
  };
  {% endif %}
  
  // Load widget script
  (function() {
    if (!document.querySelector('script[src*="nusense-tryon-widget.js"]')) {
      const script = document.createElement('script');
      script.src = '{{ widget_url }}/nusense-tryon-widget.js';
      script.async = true;
      script.defer = true;
      script.onload = function() {
        if (window.NUSENSE_CONFIG && window.NUSENSE_CONFIG.debug) {
          console.log('NUSENSE TryON Widget loaded successfully');
        }
      };
      script.onerror = function() {
        console.error('Failed to load NUSENSE TryON Widget from {{ widget_url }}');
      };
      document.head.appendChild(script);
    }
  })();
</script>

